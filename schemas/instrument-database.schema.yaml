$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://puranwater.com/schemas/instrument-database.schema.yaml"
title: instrument_database
description: |
  Unified schema for Instrument Index and IO List generation.
  Single source of truth linking instrument identification to IO signals.

type: object
required:
  - project_id
  - revision
  - instruments

properties:
  project_id:
    type: string
    pattern: "^PRJ-[0-9]{4}-[0-9]{3}-.+$"
    description: "Project identifier (e.g., PRJ-2025-001-MBR-12MLD)"

  revision:
    type: object
    required:
      - number
      - date
      - by
    properties:
      number:
        type: string
        pattern: "^[A-Z0-9]+$"
        description: "Revision number (A, B, C or 0, 1, 2)"
      date:
        type: string
        format: date
        description: "Revision date (YYYY-MM-DD)"
      by:
        type: string
        description: "Author initials"
      description:
        type: string
        description: "Revision description"
      history:
        type: array
        items:
          type: object
          properties:
            number:
              type: string
            date:
              type: string
            by:
              type: string
            description:
              type: string

  source_pids:
    type: array
    items:
      type: object
      required:
        - pid_number
        - source_type
      properties:
        pid_number:
          type: string
          description: "P&ID drawing number (e.g., PID-001)"
        source_type:
          type: string
          enum:
            - dexpi_xml
            - pdf_extracted
            - manual
          description: "How instruments were extracted"
        source_path:
          type: string
          description: "Path to source file"
        extraction_date:
          type: string
          format: date-time
        off_page_connectors:
          type: array
          items:
            type: object
            properties:
              from_page:
                type: string
              to_page:
                type: string
              loop_id:
                type: string
          description: "Cross-page loop connections"

  instruments:
    type: array
    items:
      $ref: "#/$defs/instrument"

$defs:
  instrument:
    type: object
    required:
      - instrument_id
      - tag
      - service_description
      - primary_signal_type
    properties:
      # Identification
      instrument_id:
        type: string
        format: uuid
        description: "Unique identifier linking Index to IO List"

      loop_id:
        type: string
        pattern: "^[A-Z]{2,4}-[0-9]+$"
        description: "ISA loop identifier (e.g., FIC-01)"

      tag:
        type: object
        required:
          - area
          - variable
          - function
          - loop_number
          - full_tag
        properties:
          area:
            type: string
            pattern: "^[0-9]{3}$"
            description: "Process area code (e.g., 200)"
          variable:
            type: string
            pattern: "^[A-Z]$"
            description: "ISA-5.1 first letter - measured variable (F, L, P, T, etc.)"
          function:
            type: string
            pattern: "^[A-Z]{1,3}$"
            description: "ISA-5.1 succeeding letters (IT, IC, T, etc.)"
          modifier:
            type: string
            pattern: "^[A-Z]*$"
            description: "Optional modifier (H, L, A, etc.)"
          category:
            type: string
            enum:
              - primary
              - indicating
              - recording
              - transmitting
              - controlling
              - switching
              - safety
            description: "Instrument category"
          loop_number:
            type: string
            pattern: "^[0-9]+[A-Z]?$"
            description: "Loop number within area (01, 01A, etc.)"
          suffix:
            type: string
            description: "Optional suffix (A, B for redundant)"
          full_tag:
            type: string
            pattern: "^[0-9]{3}-[A-Z]{2,5}-[0-9]+[A-Z]?$"
            description: "Complete tag: {area}-{variable}{function}{modifier}-{loop}"

      # Equipment association
      equipment_tag:
        type:
          - string
          - "null"
        pattern: "^[0-9]{3}-[A-Z]{1,4}-[0-9]+$"
        description: "Associated equipment tag (null if line-mounted)"

      pipeline_tag:
        type:
          - string
          - "null"
        pattern: "^[0-9]{3}-PL-[0-9]+$"
        description: "Pipeline tag for line-mounted instruments"

      # Service
      service_description:
        type: string
        minLength: 5
        description: "What the instrument measures/controls"

      # Location
      location:
        type: object
        properties:
          pid_reference:
            type: string
            description: "P&ID drawing number"
          physical_location:
            type: string
            enum:
              - Field
              - MCC
              - Panel
              - DCS
              - Local
            description: "Physical installation location"

      # Device specification (Instrument Index)
      device:
        type: object
        properties:
          type:
            type: string
            description: "Instrument type (Electromagnetic Flow Meter, etc.)"
          manufacturer:
            type: string
            description: "Preferred manufacturer"
          model:
            type: string
            description: "Model number"
          accuracy_class:
            type: string
            description: "Accuracy specification"
          calibration_interval:
            type: string
            description: "Calibration frequency"

      # Measurement (Instrument Index)
      measurement:
        type: object
        properties:
          measured_variable:
            type: string
            description: "What is measured (Flow, Level, Pressure, etc.)"
          range_min:
            type: number
            description: "Minimum range value"
          range_max:
            type: number
            description: "Maximum range value"
          range_unit:
            type: string
            description: "Engineering unit"

      # Alarms (Instrument Index)
      alarms:
        type: object
        properties:
          lolo:
            type: number
            description: "Low-Low alarm setpoint"
          lo:
            type: number
            description: "Low alarm setpoint"
          hi:
            type: number
            description: "High alarm setpoint"
          hihi:
            type: number
            description: "High-High alarm setpoint"

      # Primary signal for Instrument Index
      primary_signal_type:
        type: string
        enum:
          - 4-20mA
          - 24V DC
          - 120V AC
          - RELAY
          - Modbus RTU
          - Modbus TCP
          - HART
          - Profibus
          - Dry Contact
        description: "Primary signal type (explicit, not derived)"

      # IO Signals (IO List)
      io_signals:
        type: array
        items:
          $ref: "#/$defs/io_signal"

      # Hazardous area
      hazardous_area:
        type: object
        properties:
          zone:
            type: string
            enum:
              - Zone_0
              - Zone_1
              - Zone_2
              - Safe
            description: "Hazardous area classification"
          ip_rating:
            type: string
            pattern: "^IP[0-9]{2}$"
            description: "Ingress protection rating"

      # Metadata
      remarks:
        type: string
        description: "Additional notes"

      provenance:
        type: object
        properties:
          source_type:
            type: string
            enum:
              - dexpi_xml
              - pdf_extracted
              - manual
          extraction_date:
            type: string
            format: date-time
          page:
            type: integer
            description: "PDF page number if extracted"
          confidence:
            type: number
            minimum: 0
            maximum: 1
            description: "Extraction confidence score"

  io_signal:
    type: object
    required:
      - io_point_id
      - signal_function
      - io_type
    properties:
      io_point_id:
        type: string
        format: uuid
        description: "Unique IO point identifier"

      signal_function:
        type: string
        enum:
          - Status
          - Control
          - Alarm
          - Measurement
          - Speed_Command
          - Speed_Feedback
          - Position_Command
          - Position_Feedback
        description: "Function of this IO signal"

      io_type:
        type: string
        enum:
          - DI
          - DO
          - AI
          - AO
          - PI
          - PO
        description: "IO type (DI/DO/AI/AO for hardwired, PI/PO for protocol)"

      signal_type:
        type: string
        enum:
          - 24V DC
          - 120V AC
          - RELAY
          - 4-20mA
          - 0-10V
          - Modbus RTU
          - Modbus TCP
          - HART
          - Profibus
          - Dry Contact
        description: "Electrical signal type"

      termination:
        type: string
        enum:
          - PLC
          - DCS
          - RTU
          - Local
        description: "Signal termination point"

      component_type:
        type: string
        description: "Component generating/receiving signal"

      plc_tag:
        type: string
        description: "PLC/DCS tag for this signal"

      field_tag:
        type: string
        description: "Field device tag"

      suffix:
        type: string
        description: "Signal suffix (YL, OL, YA, HS, etc.)"

      description:
        type: string
        description: "Signal description"

      protocol:
        type:
          - string
          - "null"
        enum:
          - Modbus RTU
          - Modbus TCP
          - HART
          - Profibus
          - null
        description: "Protocol for PI/PO signals"

      # Marshalling details (optional)
      marshalling:
        type: object
        properties:
          cabinet:
            type: string
            description: "Cabinet/panel identifier"
          card:
            type: string
            description: "IO card identifier"
          channel:
            type: integer
            minimum: 1
            description: "Channel number on card"
          terminal:
            type: string
            description: "Terminal block reference"
          cable_tag:
            type: string
            description: "Associated cable tag"

      # Pattern reference
      pattern_source:
        type: string
        description: "IO pattern used to generate this signal"

      # Electrical characteristics
      electrical:
        type: object
        properties:
          feeder_type:
            type: string
            enum:
              - DOL
              - VFD
              - Soft-Starter
              - Vendor Panel
              - Direct
            description: "Electrical feeder type (determines IO count)"
          starter_type:
            type: string
            description: "Motor starter specification"
          power_kW:
            type: number
            description: "Power rating in kW"
